name: Build and Deploy to DeployGate

# DISABLED - Using local deployment instead
# Uncomment the on: section below to enable automatic deployment on push
on:
  # push:
  #   branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'gradle'
            
      - name: Make gradlew executable
        run: chmod +x ./gradlew
        
      - name: Setup signing keystore
        run: |
          if [ -n "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" ]; then
            echo "Extracting keystore from secret..."
            echo "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" | base64 -d > json-viewer-release-key.jks
            chmod 600 json-viewer-release-key.jks
            echo "‚úÖ Keystore extracted"
          elif [ -f "app/json-viewer-release-key.jks" ]; then
            echo "Using keystore from app/ directory"
            cp app/json-viewer-release-key.jks json-viewer-release-key.jks
            chmod 600 json-viewer-release-key.jks
          elif [ -f "json-viewer-release-key.jks" ]; then
            echo "‚úÖ Keystore found at root"
          else
            echo "‚ö†Ô∏è  Warning: Keystore file not found. Build may fail if signing is required."
          fi
        
      - name: Build Release AAB
        env:
          KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}
        run: |
          ./gradlew bundleRelease --no-configuration-cache
          
      - name: Deploy to DeployGate via API
        env:
          DEPLOYGATE_API_TOKEN: ${{ secrets.DEPLOYGATE_API_TOKEN }}
          DEPLOYGATE_USER_NAME: ${{ secrets.DEPLOYGATE_USER_NAME }}
        run: |
          # Find the built AAB file
          AAB_FILE=$(find app/build/outputs/bundle/release -name "*.aab" | head -1)
          if [ -z "$AAB_FILE" ]; then
            echo "‚ùå No AAB file found"
            exit 1
          fi
          
          echo "üì¶ Uploading $AAB_FILE to DeployGate..."
          
          # Upload to DeployGate using their API
          RESPONSE=$(curl -X POST \
            -F "file=@$AAB_FILE" \
            -F "message=CI Build - $(date +'%Y-%m-%d %H:%M')" \
            -F "release_note=Automated CI/CD build from commit ${{ github.sha }}" \
            -H "Authorization: token $DEPLOYGATE_API_TOKEN" \
            "https://deploygate.com/api/users/$DEPLOYGATE_USER_NAME/apps")
          
          echo "Response: $RESPONSE"
          
          if echo "$RESPONSE" | grep -q '"error"'; then
            echo "‚ùå DeployGate upload failed"
            exit 1
          else
            echo "‚úÖ Successfully uploaded to DeployGate"
          fi
        continue-on-error: true
        
      - name: Upload build artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: app-release-aab
          path: app/build/outputs/bundle/release/*.aab
          retention-days: 7
          if-no-files-found: ignore

